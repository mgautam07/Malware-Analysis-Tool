from tkinter import *
from tkinter import filedialog
from extractor import predict_file
import ttkbootstrap as tb
# from ttkbootstrap import Style
import os
import hashlib
import yara 
import sys

def resource_path(relative_path):
    try:
        base_path = sys._MEIPASS2
    except Exception:
        base_path = os.path.abspath(".")

    return os.path.join(base_path, relative_path)


root = tb.Window(themename="cosmo")
root.title("Malware Analysis Tool")
img = PhotoImage(file=resource_path('assets\\images\\finger.png'))
root.iconphoto(False, img)
# Set the size of the window
root.geometry("800x600")


# Function to analyze the selected file
def analyze_file(file_path):
    # Get file information
    file_size = os.path.getsize(file_path)
    file_hash = hashlib.md5(open(file_path, 'rb').read()).hexdigest()
    file_type = file_path.split('.')[-1]
    author = "File author"
    prediction = 2
    if file_type == 'exe':
        prediction = predict_file(file_path)
    
    
    # Display the file information
    author_label.config(text="Author: " + author, fg="blue")
    hash_label.config(text="Hash: " + file_hash, fg="blue")
    type_label.config(text="Type: " + file_type, fg="blue")
    size_label.config(text="Size: " + str(file_size) + " bytes", fg="blue")
    prediction_label.config(text="Prediction: " + ['Malicious', 'Legitimate', 'Invalid file type'][prediction], fg="blue")

def yara_analyze_file(file_path):
    rules = yara.load(resource_path('assets\\rules\\compiled_rules.yara'))
    matches = rules.match(file_path)
    if matches:
        yara_label.config(text="Yara: " + str(matches[0]), fg="red")
    else:
        yara_label.config(text="Yara: No match found", fg="green")

# Function to select a file for analysis
def select_file():
    file_path = filedialog.askopenfilename()
    if file_path:
        file_label.config(text="Selected file: " + file_path)

        # Call the analyze_file function with the selected file path
        analyze_file(file_path)
        yara_analyze_file(file_path)

# Create the UI elements
result_label = Label(root, text="MAT", font=('Times', 40))
result_label.pack(pady=(15,40))

logo = Label(root,image=img)
logo.pack(fill=X)

file_frame = Frame(root, padx=10, pady=10)
file_frame.pack(fill=X)


file_button = tb.Button(file_frame, text="Choose File", command=select_file, style='Outline.TButton')
file_button.pack(padx=(10,10),pady=(10,10))

file_label = Label(file_frame, text="No file selected")
file_label.pack(padx=10, pady=10)

result_frame = Frame(root, padx=10, pady=10)
result_frame.pack(fill=X)

result_label = Label(result_frame, text="Analysis result", font='a 16 bold')
result_label.pack(side=LEFT, padx=35)

info_frame = Frame(root, padx=10, pady=10)
info_frame.pack(fill=X)

author_label = Label(info_frame, text="Author: ", fg="red")
author_label.pack(side=TOP, anchor=W, padx=15)

hash_label = Label(info_frame, text="Hash: ", fg="red")
hash_label.pack(side=TOP, anchor=W, padx=15)

type_label = Label(info_frame, text="Type: ", fg="red")
type_label.pack(side=TOP, anchor=W, padx=15)

size_label = Label(info_frame, text="Size: ", fg="red")
size_label.pack(side=TOP, anchor=W, padx=15)

prediction_label = Label(info_frame, text="Prediction: ", font='a 12 bold')
prediction_label.pack()

yara_label = Label(info_frame, text="Yara: ", font='a 12 bold')
yara_label.pack()

root.mainloop()