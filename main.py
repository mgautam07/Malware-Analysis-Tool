from tkinter import *
from tkinter import filedialog
from extractor import predict_file
import ttkbootstrap as tb
import os
import hashlib
import yara
import sys

def resource_path(relative_path):
    try:
        base_path = sys._MEIPASS2
    except Exception:
        base_path = os.path.abspath(".")

    return os.path.join(base_path, relative_path)


root = tb.Window(themename="cosmo")
root.title("Malware Analysis Tool")
img = PhotoImage(file=resource_path('assets\\images\\logo.png'))
root.iconphoto(False, img)

# Set the size of the window
root.geometry("800x600")

def delete_file(file_path):
    if os.path.isfile(file_path) or os.path.islink(file_path):
        os.remove(file_path)

# Function to analyze the selected file
def analyze_file(file_path):
    # Get file information
    file_size = os.path.getsize(file_path)
    file_hash = hashlib.md5(open(file_path, 'rb').read()).hexdigest()
    file_type = file_path.split('.')[-1]
    author = "File author"
    prediction = 2
    if file_type == 'exe':
        prediction = predict_file(file_path)
    
    if prediction == 0:
        delete_button.configure(state=ACTIVE, command=lambda: delete_file(file_path))

    # Display the file information
    author_label.config(text="Author: " + author, fg="blue")
    hash_label.config(text="Hash: " + file_hash, fg="blue")
    type_label.config(text="Type: " + file_type, fg="blue")
    size_label.config(text="Size: " + str(file_size) + " bytes", fg="blue")
    prediction_label.config(text="Prediction: " + ['Malicious', 'Legitimate', 'Invalid file type'][prediction], fg="blue")

def yara_analyze_file(file_path):
    rules = yara.load(resource_path('assets\\rules\\compiled_rules.yara'))
    matches = rules.match(file_path)
    if matches:
        yara_label.config(text="Yara: " + str(matches[0]), fg="red")
    else:
        yara_label.config(text="Yara: No match found", fg="green")

# Function to select a file for analysis
def select_file():
    file_path = filedialog.askopenfilename()
    if file_path:
        file_label.config(text="Selected file: " + file_path)

        # Call the analyze_file function with the selected file path
        analyze_file(file_path)
        yara_analyze_file(file_path)

# Create the UI elements
file_frame = Frame(root, padx=10, pady=10)
file_frame.pack(fill=X)

file_button = Button(file_frame, text="Select File", command=select_file)
file_button.pack(side=LEFT)

file_label = Label(file_frame, text="No file selected")
file_label.pack(side=LEFT, padx=10)

result_frame = Frame(root, padx=10, pady=10)
result_frame.pack(fill=X)

result_label = Label(result_frame, text="Analysis result")
result_label.pack(side=LEFT)

info_frame = Frame(root, padx=10, pady=10)
info_frame.pack(fill=X)

author_label = Label(info_frame, text="Author: ", fg="red")
author_label.pack(side=TOP, anchor=W)

hash_label = Label(info_frame, text="Hash: ", fg="red")
hash_label.pack(side=TOP, anchor=W)

type_label = Label(info_frame, text="Type: ", fg="red")
type_label.pack(side=TOP, anchor=W)

size_label = Label(info_frame, text="Size: ", fg="red")
size_label.pack(side=TOP, anchor=W)

prediction_label = Label(info_frame, text="Prediction: ")
prediction_label.pack(side=TOP, anchor=W)

yara_label = Label(info_frame, text="Yara: ")
yara_label.pack(side=TOP, anchor=W)

delete_button = Button(state=DISABLED, text="Delete")
delete_button.pack(side=TOP, anchor=W)
root.mainloop()